基于飞书开放平台的企业成员管理机器人，提供成员添加、删除、状态查询等功能，并自动同步操作记录到飞书多维表格。

## 功能特性

- ✅ **成员管理**: 添加/删除企业成员
- ✅ **状态查询**: 实时查询成员状态  
- ✅ **Cookie管理**: 自动检查Cookie有效性
- ✅ **多维表格同步**: 所有操作自动记录到飞书多维表格
- ✅ **实时通知**: 操作结果实时反馈

## 环境要求

- Python 3.7+
- 飞书企业账号、应用凭证
- 有效的Cookie凭证

## 安装部署

### 1. 克隆项目
```bash
git clone <项目地址>
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置环境变量
复制 `.env.example` 为 `.env` 并填写以下配置：

```env
FEISHU_APP_ID=你的应用ID
FEISHU_APP_SECRET=你的应用密钥
FEISHU_VERIFICATION_TOKEN=你的验证令牌
FEISHU_ENCRYPT_KEY=你的加密密钥
BITABLE_APP_TOKEN=你的多维表格AppToken
BITABLE_TABLE_ID=你的表格ID
```

### 4. 配置Cookie
- 将有效的Cookie文件放置于 `ata/cookie.har`
- 获取har文件方式请自行搜索

## 使用说明

### 在飞书对话中使用

向机器人发送以下指令：

#### 成员管理指令
- `添加成员 [userid]` - 添加成员到企业
- `删除成员 [userid]` - 从企业删除成员
- `用户状态 [userid]` - 查询成员状态

#### 系统管理指令
- `Cookie状态` - 检查Cookie有效性
- `帮助` - 显示帮助信息
- `版本` - 显示系统版本

### 指令示例

```
用户: 添加成员 20*****15
机器人: 添加用户 20*****15 成功

用户: 删除成员 20*****15
机器人: 删除用户 20*****15 成功

用户: 用户状态 20*****15
机器人: 
👤 用户状态查询
用户ID: 20*****15
添加时间: 2025-08-25 11:45:17
过期时间: 2025-08-26 11:45:17
剩余有效期: 23小时59分钟

用户: Cookie状态
机器人: 
🍪 Cookie状态检查
有效性: ✅ 有效
上次检查: 2025-08-25 11:45:35
下次检查: 2025-08-25 12:45:35
```

## 功能详解

### 1. 添加成员功能

**功能描述**: 将指定用户ID的成员添加到企业

**执行流程**:
1. 用户发送 `添加成员 [userid]` 指令
2. 系统验证Cookie有效性
3. 调用觅智API添加成员
4. 记录用户添加时间
5. 同步操作记录到多维表格
6. 发送成功/失败通知

**错误处理**:
- Cookie过期时自动提示更新
- API调用失败时重试机制
- 网络异常时友好错误提示

### 2. 删除成员功能

**功能描述**: 从企业删除指定用户ID的成员

**执行流程**:
1. 用户发送 `删除成员 [userid]` 指令
2. 系统验证Cookie有效性
3. 调用觅智API删除成员
4. 从用户管理器中移除用户
5. 同步操作记录到多维表格
6. 发送成功/失败通知

### 3. 用户状态查询

**功能描述**: 查询指定用户ID的成员状态

**返回信息**:
- 用户当前状态（正常/异常）
- 最后操作时间
- 操作历史记录

### 4. 多维表格同步

**同步内容**:
- 操作类型（添加/删除/查询）
- 操作状态（成功/失败/错误）
- 操作时间戳
- 执行用户信息
- 详细错误信息（如果失败）

**表格字段**:
- 事件记录：`[userid] - [操作类型]操作: [状态] - [消息]`
- 操作时间：自动记录
- 执行用户：OpenID
- 操作状态：success/failed/error

## 技术架构

### 系统组件

```
OpenLark/
├── a.feishuSDK/          # 飞书SDK核心模块
│   ├── feishu_bot.py     # 飞书机器人主逻辑
│   ├── sdk_connect.py    # WebSocket长连接
│   ├── user_manager.py   # 用户管理模块
│   └── data/            # 数据文件目录
├── b.manager/           # 管理工具模块
└── 多维表格同步模块       # 飞书多维表格集成
```

### 核心模块说明

#### feishu_bot.py
- 飞书事件处理核心
- 成员管理业务逻辑
- Cookie有效性检查
- 多维表格同步接口

#### sdk_connect.py  
- WebSocket长连接管理
- 飞书事件处理器注册
- 实时消息收发处理

#### user_manager.py
- 用户数据持久化存储
- 用户状态管理
- 操作历史记录

## 故障排除

### 常见问题

1. **Cookie过期错误**
   - 症状: "Cookie已过期，请更新HAR文件"
   - 解决方案: 更新 `data/cookie.har` 文件

2. **飞书连接失败**
   - 症状: SDK连接错误或超时
   - 解决方案: 检查网络连接和应用凭证

3. **多维表格同步失败**
   - 症状: 操作成功但表格未更新
   - 解决方案: 检查多维表格权限和配置

### 日志查看

程序运行日志包含详细的操作信息：

```log
[2025-08-25 11:45:05][添加成员响应状态码] 200
[2025-08-25 11:45:05][添加成员响应内容] {'code': 200, 'msg': '添加员工成功', 'data': ''}
[2025-08-25 11:45:05][同步到多维表格-成功] 该操作执行用户OpenID：ou_525*******************9d2
```

## 版本历史

### v1.0.0 (2025-08-25)
- ✅ 成员添加/删除功能
- ✅ 用户状态查询  
- ✅ 多维表格自动同步
- ✅ Cookie有效性检查
- ✅ 飞书实时消息交互

## 免责声明

- 本系统仅用于企业内部成员管理，请遵守相关法律法规和政策。请确保已获得相应的操作权限和授权。
- 觅智网成员管理API接口为官方未公开接口，非法调用可能导致账号被封禁，请自行斟酌。
