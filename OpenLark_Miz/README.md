# 飞书机器人SDK

## 功能特性

- ✅ 基于飞书开放平台SDK的机器人实现
- ✅ 支持长连接接收飞书事件回调
- ✅ 成员管理功能（添加/删除成员）
- ✅ 操作结果自动同步到飞书多维表格
- ✅ 支持多维表格事件状态字段

## 环境要求

- Python 3.7+
- 飞书企业自建应用

## 安装依赖

```bash
pip install -r requirements.txt
```

## 配置说明

### 1. 飞书应用配置

在飞书开放平台创建自建应用，配置以下信息：

1. 基本信息 → 获取 App ID 和 App Secret
2. 事件订阅 → 选择"使用长连接接收回调"方式
   - 无需配置请求网址、验证令牌和加密密钥
   - SDK自动处理鉴权和连接建立
3. 权限管理 → 按照以下格式导入权限配置：

```json
{
  "scopes": {
    "tenant": [
      "im:message:send_as_bot",
      "docx:document"
    ],
    "user": [
      "docx:document"
    ]
  }
}
```

### 2. 环境变量配置

确保 `.env` 文件包含以下配置：

```env
# 飞书应用配置
FEISHU_APP_ID=你的应用ID
FEISHU_APP_SECRET=你的应用密钥
FEISHU_VERIFICATION_TOKEN=你的验证令牌
FEISHU_ENCRYPT_KEY=你的加密密钥

# 多维表格配置
BITABLE_APP_TOKEN=多维表格应用Token
BITABLE_TABLE_ID=多维表格ID
```

## 启动服务

### 长连接模式（推荐）
```bash
python wss_server.py
```

优势：
- 无需公网IP和域名
- 内置鉴权，无需处理解密验签
- 本地开发环境即可接收回调
- 连接成功后控制台显示：`connected to wss://msg-frontier.feishu.cn/...`

## 使用说明

### 在飞书对话中使用

向机器人发送以下指令：

- `添加成员 [userid]` - 添加成员到企业
- `删除成员 [userid]` - 从企业删除成员
- `帮助` - 显示帮助信息

### 示例

```
用户: 添加成员 12345
机器人: 添加成员成功

用户: 删除成员 12345  
机器人: 删除成员成功
```

### 用户ID格式要求

用户ID必须为5-20位的纯数字，否则操作将失败并返回错误信息。

示例：
- 有效：`12345`, `123456789012345`
- 无效：`abc123`（包含字母）, `123`（长度不足）, `123456789012345678901`（长度超过20位）

### 常见问题及解决方案

1. **添加成员操作失败**
   - 错误信息：`{'code': 401, 'msg': 'Please log in again!!'}`
   - 原因：觅智网Cookie已过期或无效
   - 解决方案：
     - 更新`data/cookie.har`文件中的Cookie
     - 确保Cookie包含正确的`ustk`和`51miz_auth`字段
     - 确保HAR文件中的请求URL与实际请求URL匹配

2. **删除成员操作失败**
   - 错误信息：`{'status': 100, 'msg': 'error user!'}`
   - 原因：提供的用户ID无效或用户不存在
   - 解决方案：
     - 检查用户ID是否正确
     - 确认用户是否已存在于企业中

## 多维表格同步

所有操作都会自动同步到飞书多维表格，记录包括：

- 操作人
- 操作时间
- 事件操作（添加用户/删除用户）
- 事件状态（成功/失败）
- 事件记录

### 事件状态字段

新增的事件状态字段用于记录操作的结果状态，包含以下选项：
- 成功：操作执行成功
- 失败：操作执行失败

该字段在多维表格中显示为单选字段，便于筛选和统计不同状态的操作记录。

## 核心类和方法

### FeishuBot

核心业务逻辑类，主要方法包括：

- `add_member()`: 添加成员到企业
- `delete_member()`: 从企业删除成员
- `_sync_to_bitable()`: 同步操作结果到多维表格
- `handle_message()`: 处理飞书消息事件

### 事件处理

- `sdk_connect.py`: 飞书事件回调处理
- `do_bitable_record_changed_event()`: 处理多维表格记录变更事件